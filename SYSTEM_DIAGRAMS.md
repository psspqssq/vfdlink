# ğŸ“Š Visual System Diagrams and Flow Charts

## Complete System Overview

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         YOUR COMPUTER (Gateway)                             â”‚
â”‚                                                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                     Web Browser (localhost:5000)                    â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”             â”‚   â”‚
â”‚  â”‚  â”‚ Start/Stop   â”‚  â”‚ Configurationâ”‚  â”‚  Real-Time   â”‚             â”‚   â”‚
â”‚  â”‚  â”‚   Buttons    â”‚  â”‚    Forms     â”‚  â”‚     Logs     â”‚             â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â–²â”€â”€â”€â”€â”€â”€â”€â”˜             â”‚   â”‚
â”‚  â”‚         â”‚                 â”‚                  â”‚                      â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚            â”‚ HTTP            â”‚ HTTP             â”‚ WebSocket                â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                    webserver.py (Flask)      â”‚                      â”‚   â”‚
â”‚  â”‚                                               â”‚                      â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”             â”‚   â”‚
â”‚  â”‚  â”‚  REST API   â”‚  â”‚   Config    â”‚  â”‚   Broadcast     â”‚             â”‚   â”‚
â”‚  â”‚  â”‚  Endpoints  â”‚  â”‚  Manager    â”‚  â”‚    Thread       â”‚             â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â–²â”€â”€â”€â”€â”€â”€â”€â”€â”˜             â”‚   â”‚
â”‚  â”‚        â”‚                â”‚                    â”‚                      â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚           â”‚ Function       â”‚ Variable           â”‚ Poll                     â”‚
â”‚           â”‚ Calls          â”‚ Access             â”‚ Messages                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                       vfdserver.py                                   â”‚   â”‚
â”‚  â”‚                                                                      â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚   â”‚
â”‚  â”‚  â”‚              Yaskawa Emulator (Modbus Server)                â”‚   â”‚   â”‚
â”‚  â”‚  â”‚                                                               â”‚   â”‚   â”‚
â”‚  â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚   â”‚   â”‚
â”‚  â”‚  â”‚  â”‚        YaskawaCallback Class                       â”‚      â”‚   â”‚   â”‚
â”‚  â”‚  â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚      â”‚   â”‚   â”‚
â”‚  â”‚  â”‚  â”‚  â”‚   setValues() - Translation Engine           â”‚  â”‚      â”‚   â”‚   â”‚
â”‚  â”‚  â”‚  â”‚  â”‚   â€¢ Receives PLC writes                      â”‚  â”‚      â”‚   â”‚   â”‚
â”‚  â”‚  â”‚  â”‚  â”‚   â€¢ Translates Yaskawa â†’ WEG                 â”‚  â”‚      â”‚   â”‚   â”‚
â”‚  â”‚  â”‚  â”‚  â”‚   â€¢ Calls _write_to_weg()                    â”‚  â”‚      â”‚   â”‚   â”‚
â”‚  â”‚  â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚      â”‚   â”‚   â”‚
â”‚  â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚   â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚   â”‚
â”‚  â”‚                           â”‚                                          â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚   â”‚
â”‚  â”‚  â”‚            WEG Client (Modbus Client)                        â”‚   â”‚   â”‚
â”‚  â”‚  â”‚  â€¢ Thread-safe with weg_lock                                 â”‚   â”‚   â”‚
â”‚  â”‚  â”‚  â€¢ Persistent connection                                     â”‚   â”‚   â”‚
â”‚  â”‚  â”‚  â€¢ Auto-reconnect on failure                                 â”‚   â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚   â”‚
â”‚  â”‚               â”‚                                                      â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                  â”‚                                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â”‚                          â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚   USB-to-Serial    â”‚     â”‚   USB-to-Serial    â”‚
        â”‚   Adapter (COM3)   â”‚     â”‚   Adapter (COM4)   â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â”‚                          â”‚
                   â”‚ RS-232/485               â”‚ RS-232/485
                   â”‚ (Modbus RTU)             â”‚ (Modbus RTU)
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚                    â”‚     â”‚                    â”‚
        â”‚   PLC/Controller   â”‚     â”‚  WEG CFW11 Drive   â”‚
        â”‚   (Thinks it's     â”‚     â”‚  (Thinks it's      â”‚
        â”‚   talking to       â”‚     â”‚  talking to a      â”‚
        â”‚   Yaskawa VFD)     â”‚     â”‚  normal Modbus     â”‚
        â”‚                    â”‚     â”‚  master)           â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                              â”‚
                                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                                    â”‚                   â”‚
                                    â”‚   Electric Motor  â”‚
                                    â”‚   (0-60 Hz)       â”‚
                                    â”‚                   â”‚
                                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Data Flow: PLC Command to Motor

```
STEP 1: PLC Sends Command
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  PLC Controller â”‚
â”‚                 â”‚  "Set frequency to 30Hz"
â”‚  Yaskawa Reg    â”‚  
â”‚  0x0002 = 3000  â”‚  [Modbus Write Command]
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜  Slave ID: 1 (or configured)
         â”‚           Reg: 0x0002
         â”‚           Value: 3000 (30.00 Hz)
         â”‚
         â”‚ Serial: 9600 baud, 8N1
         â”‚ Physical: RS-232 or RS-485
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚     COM3 (USB-to-Serial Adapter)             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â”‚ Binary Modbus RTU Frame:
         â”‚ [01][06][00][02][0B][B8][CRC][CRC]
         â”‚  â”‚   â”‚   â”‚   â”‚    â”‚    â””â”€ Error Check
         â”‚  â”‚   â”‚   â”‚   â”‚    â””â”€â”€â”€â”€â”€ Value: 3000
         â”‚  â”‚   â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ Register: 0x0002
         â”‚  â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ Function: Write Single Reg
         â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ Slave ID: 1
         â”‚
         â–¼
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘                    GATEWAY - vfdserver.py                           â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

STEP 2: Modbus Server Receives
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  StartSerialServer (pymodbus)                                       â”‚
â”‚  â€¢ Listens on COM3                                                  â”‚
â”‚  â€¢ Decodes Modbus RTU frame                                         â”‚
â”‚  â€¢ Extracts: Reg=0x0002, Value=3000                                 â”‚
â”‚  â€¢ Routes to ModbusSlaveContext                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ModbusSlaveContext.setValues()                                     â”‚
â”‚  â€¢ Calls our custom class: YaskawaCallback                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼

STEP 3: Translation Logic
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  YaskawaCallback.setValues(address=0x0002, values=[3000])           â”‚
â”‚                                                                     â”‚
â”‚  reg_address = 0x0002  â† Frequency register                        â”‚
â”‚  val = 3000            â† Yaskawa value                             â”‚
â”‚                                                                     â”‚
â”‚  â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• TRANSLATION â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—    â”‚
â”‚  â•‘                                                             â•‘    â”‚
â”‚  â•‘  1. Calculate Hz:                                          â•‘    â”‚
â”‚  â•‘     freq_hz = 3000 / 100.0 = 30.0 Hz                       â•‘    â”‚
â”‚  â•‘                                                             â•‘    â”‚
â”‚  â•‘  2. Calculate percentage of max:                           â•‘    â”‚
â”‚  â•‘     percentage = 3000 / 6000 = 0.5 (50%)                   â•‘    â”‚
â”‚  â•‘                                                             â•‘    â”‚
â”‚  â•‘  3. Scale to WEG format (0-8192 = 0-100%):                 â•‘    â”‚
â”‚  â•‘     val_weg = 0.5 Ã— 8192 = 4096                            â•‘    â”‚
â”‚  â•‘                                                             â•‘    â”‚
â”‚  â•‘  4. Target register:                                       â•‘    â”‚
â”‚  â•‘     WEG P0683 (Speed Reference)                            â•‘    â”‚
â”‚  â•‘                                                             â•‘    â”‚
â”‚  â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•    â”‚
â”‚                                                                     â”‚
â”‚  Call: _write_to_weg(683, 4096, "FREQUENCY")                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼

STEP 4: Thread-Safe Write
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  _write_to_weg(register=683, value=4096)                            â”‚
â”‚                                                                     â”‚
â”‚  with weg_lock:  â† ACQUIRE LOCK (wait if another thread is using)  â”‚
â”‚      try:                                                           â”‚
â”‚          # Check connection                                         â”‚
â”‚          if not weg_client.connected:                               â”‚
â”‚              init_weg_client()  # Reconnect                         â”‚
â”‚                                                                     â”‚
â”‚          # Send Modbus command                                      â”‚
â”‚          result = weg_client.write_register(                        â”‚
â”‚              address=683,                                           â”‚
â”‚              value=4096,                                            â”‚
â”‚              slave=6  â† WEG's Modbus address                        â”‚
â”‚          )                                                          â”‚
â”‚                                                                     â”‚
â”‚          if result.isError():                                       â”‚
â”‚              log("ERROR: ...")                                      â”‚
â”‚          else:                                                      â”‚
â”‚              log("SUCCESS: Written P0683 = 4096")                   â”‚
â”‚                                                                     â”‚
â”‚      finally:                                                       â”‚
â”‚          # RELEASE LOCK automatically                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â”‚ Builds Modbus RTU Frame:
         â”‚ [06][06][02][AB][10][00][CRC][CRC]
         â”‚  â”‚   â”‚    â”‚     â”‚    â””â”€ CRC
         â”‚  â”‚   â”‚    â”‚     â””â”€â”€â”€â”€â”€â”€ Value: 4096
         â”‚  â”‚   â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ Register: 683 (0x02AB)
         â”‚  â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ Function: Write Single Reg
         â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ Slave ID: 6
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚     COM4 (USB-to-Serial Adapter)             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â”‚ Serial: 9600 baud, 8N1
         â”‚ Physical: RS-232 or RS-485
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  WEG CFW11 Driveâ”‚
â”‚                 â”‚
â”‚  Receives:      â”‚
â”‚  Reg 0x02AB     â”‚  (P0683 in hex)
â”‚  Value: 4096    â”‚  (50% of 8192)
â”‚                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  â”‚ Interprets: â”‚
â”‚  â”‚ â€¢ 4096/8192 â”‚
â”‚  â”‚   = 50%     â”‚
â”‚  â”‚ â€¢ 50% of    â”‚
â”‚  â”‚   max speed â”‚
â”‚  â”‚ â€¢ If max =  â”‚
â”‚  â”‚   60Hz, run â”‚
â”‚  â”‚   at 30Hz   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Electric Motor â”‚
â”‚  â€¢ Spins at     â”‚
â”‚    30 Hz        â”‚
â”‚  â€¢ Roughly      â”‚
â”‚    1800 RPM     â”‚
â”‚    (for 2-pole) â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Frequency Scaling Explained Visually

```
YASKAWA SCALE                 CONVERSION                WEG SCALE
(0-6000 = 0-60Hz)                                       (0-8192 = 0-100%)

0    â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€> 0
     â”‚                                                  â”‚
     â”‚  val_weg = (val_yaskawa / 6000) Ã— 8192          â”‚
     â”‚                                                  â”‚
1500 â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€> 2048
(15 Hz)            â”‚    1500/6000 = 0.25               (25%)
                   â”‚    0.25 Ã— 8192 = 2048
                   â”‚
3000 â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€> 4096
(30 Hz)            â”‚          â”‚   3000/6000 = 0.5      (50%)
                   â”‚          â”‚   0.5 Ã— 8192 = 4096
                   â”‚          â”‚
4500 â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€> 6144
(45 Hz)            â”‚          â”‚          â”‚  0.75Ã—8192  (75%)
                   â”‚          â”‚          â”‚
6000 â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€> 8192
(60 Hz = MAX)                                          (100%)


KEY INSIGHT:
Both scales represent the SAME physical speed, just in different formats!

Yaskawa: Absolute frequency (Hz Ã— 100)
WEG:     Percentage of configured maximum (0-100% as 0-8192)
```

---

## Thread Execution Timeline

```
TIME â†’

Thread 1: Main (Flask Web Server)
â”‚
â”œâ”€ Start Flask app
â”‚  â”‚
â”‚  â”œâ”€ Create gateway thread â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  â”‚                                       â”‚
â”‚  â”œâ”€ Create broadcast thread â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚                                    â”‚  â”‚
â”‚  â”œâ”€ Listen for web requests...       â”‚  â”‚
â”‚  â”‚                                    â”‚  â”‚
â”‚  â”œâ”€ GET /api/config â”€â”€â”€â”€> return     â”‚  â”‚
â”‚  â”‚                        config      â”‚  â”‚
â”‚  â”‚                                    â”‚  â”‚
â”‚  â”œâ”€ POST /api/server/start           â”‚  â”‚
â”‚  â”‚  â””â”€> call start_server_thread()   â”‚  â”‚
â”‚  â”‚                                    â”‚  â”‚
â”‚  â”œâ”€ POST /api/config â”€â”€â”€> update     â”‚  â”‚
â”‚  â”‚                        config      â”‚  â”‚
â”‚  â”‚                                    â”‚  â”‚
â”‚  â””â”€ [continues running...]           â”‚  â”‚
â”‚                                       â”‚  â”‚
Thread 2: Gateway Server               â”‚  â”‚
     (daemon thread)                    â”‚  â”‚
     â”‚                                  â”‚  â”‚
     â”œâ”€ Started â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
     â”‚                                     â”‚
     â”œâ”€ init_weg_client()                 â”‚
     â”‚  â””â”€ Connect to COM4                â”‚
     â”‚                                     â”‚
     â”œâ”€ StartSerialServer(COM3) â”€â”€â”       â”‚
     â”‚  [BLOCKS HERE]              â”‚       â”‚
     â”‚  Waiting for PLC...         â”‚       â”‚
     â”‚                             â”‚       â”‚
     â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚
     â”‚  â”‚ PLC writes register              â”‚
     â”‚  â”‚                                  â”‚
     â”‚  â”œâ”€> YaskawaCallback.setValues()    â”‚
     â”‚  â”‚   â”‚                              â”‚
     â”‚  â”‚   â”œâ”€ Translate                   â”‚
     â”‚  â”‚   â”‚                              â”‚
     â”‚  â”‚   â””â”€ _write_to_weg()             â”‚
     â”‚  â”‚       â”‚                          â”‚
     â”‚  â”‚       â”œâ”€ Acquire weg_lock â”€â”€â”    â”‚
     â”‚  â”‚       â”‚                      â”‚    â”‚
     â”‚  â”‚       â”œâ”€ write_register()    â”‚    â”‚
     â”‚  â”‚       â”‚   (to WEG via COM4)  â”‚    â”‚
     â”‚  â”‚       â”‚                      â”‚    â”‚
     â”‚  â”‚       â””â”€ Release weg_lock â—„â”€â”€â”˜    â”‚
     â”‚  â”‚                                  â”‚
     â”‚  â””â”€> [wait for next PLC command]    â”‚
     â”‚                                     â”‚
     â””â”€ [continues running...]             â”‚
                                           â”‚
Thread 3: Broadcast Messages              â”‚
     (daemon thread)                       â”‚
     â”‚                                     â”‚
     â”œâ”€ Started â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚
     â”œâ”€ Loop:
     â”‚  â”‚
     â”‚  â”œâ”€ sleep(0.5s)
     â”‚  â”‚
     â”‚  â”œâ”€ Check len(recent_messages)
     â”‚  â”‚
     â”‚  â”œâ”€ If new messages:
     â”‚  â”‚  â””â”€> socketio.emit('new_messages')
     â”‚  â”‚      â””â”€> Browser receives update
     â”‚  â”‚
     â”‚  â”œâ”€ sleep(0.5s)
     â”‚  â”‚
     â”‚  â”œâ”€ Check len(recent_messages)
     â”‚  â”‚
     â”‚  â””â”€ [repeat forever...]
     â”‚
     â””â”€ [continues running...]


THREAD SAFETY: The weg_lock

Scenario: Two PLC commands arrive close together

Thread 2a: (handling command 1)          Thread 2b: (handling command 2)
â”‚                                        â”‚
â”œâ”€ _write_to_weg(682, 1)                 â”œâ”€ _write_to_weg(683, 4096)
â”‚  â”‚                                     â”‚  â”‚
â”‚  â”œâ”€ Acquire weg_lock â”€â”€â”               â”‚  â”œâ”€ Try acquire weg_lock
â”‚  â”‚  âœ“ Got it!          â”‚               â”‚  â”‚  âœ— BLOCKED (waiting...)
â”‚  â”‚                     â”‚               â”‚  â”‚
â”‚  â”œâ”€ write_register()   â”‚               â”‚  â”‚  [waiting...]
â”‚  â”‚  (safe, no conflict)â”‚               â”‚  â”‚
â”‚  â”‚                     â”‚               â”‚  â”‚  [waiting...]
â”‚  â””â”€ Release weg_lock â—„â”€â”€â”˜               â”‚  â”‚
â”‚                                        â”‚  â”‚
â”‚                                        â”‚  â””â”€ âœ“ Now got lock!
â”‚                                        â”‚
â”‚                                        â”œâ”€ write_register()
â”‚                                        â”‚  (safe, no conflict)
â”‚                                        â”‚
â”‚                                        â””â”€ Release weg_lock
â”‚
Result: Commands execute sequentially, no corruption! âœ“
```

---

## Modbus Frame Anatomy

```
YASKAWA (PLC) TO GATEWAY - Write Register 0x0002 with value 3000
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Modbus RTU Frame (8 bytes)                   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Byte â”‚  0   â”‚  1   â”‚  2   â”‚  3   â”‚  4   â”‚  5   â”‚  6   â”‚   7    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Hex  â”‚ 0x01 â”‚ 0x06 â”‚ 0x00 â”‚ 0x02 â”‚ 0x0B â”‚ 0xB8 â”‚ 0xXX â”‚ 0xXX   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Dec  â”‚  1   â”‚  6   â”‚  0   â”‚  2   â”‚  11  â”‚ 184  â”‚  ??  â”‚  ??    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚Field â”‚Slave â”‚Func  â”‚ Reg  â”‚ Reg  â”‚ Val  â”‚ Val  â”‚ CRC  â”‚  CRC   â”‚
â”‚      â”‚ ID   â”‚Code  â”‚ Hi   â”‚ Lo   â”‚ Hi   â”‚ Lo   â”‚ Lo   â”‚  Hi    â”‚
â””â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”˜
   â”‚      â”‚      â”‚            â”‚            â”‚             â”‚
   â”‚      â”‚      â”‚            â”‚            â”‚             â””â”€ Error detection
   â”‚      â”‚      â”‚            â”‚            â””â”€ Value: 0x0BB8 = 3000
   â”‚      â”‚      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€ Register address: 0x0002
   â”‚      â””â”€ Function 0x06 = Write Single Register
   â””â”€ Slave ID 1 (the "Yaskawa" we're emulating)


GATEWAY TO WEG - Write Register 683 (0x02AB) with value 4096
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Modbus RTU Frame (8 bytes)                   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Byte â”‚  0   â”‚  1   â”‚  2   â”‚  3   â”‚  4   â”‚  5   â”‚  6   â”‚   7    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Hex  â”‚ 0x06 â”‚ 0x06 â”‚ 0x02 â”‚ 0xAB â”‚ 0x10 â”‚ 0x00 â”‚ 0xXX â”‚ 0xXX   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Dec  â”‚  6   â”‚  6   â”‚  2   â”‚ 171  â”‚  16  â”‚  0   â”‚  ??  â”‚  ??    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚Field â”‚Slave â”‚Func  â”‚ Reg  â”‚ Reg  â”‚ Val  â”‚ Val  â”‚ CRC  â”‚  CRC   â”‚
â”‚      â”‚ ID   â”‚Code  â”‚ Hi   â”‚ Lo   â”‚ Hi   â”‚ Lo   â”‚ Lo   â”‚  Hi    â”‚
â””â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”˜
   â”‚      â”‚      â”‚            â”‚            â”‚             â”‚
   â”‚      â”‚      â”‚            â”‚            â”‚             â””â”€ Error detection
   â”‚      â”‚      â”‚            â”‚            â””â”€ Value: 0x1000 = 4096
   â”‚      â”‚      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€ Register: 0x02AB = 683 (P0683)
   â”‚      â””â”€ Function 0x06 = Write Single Register
   â””â”€ Slave ID 6 (WEG CFW11 configured address)


CRC CALCULATION (Simplified)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Input: All bytes except CRC                                â”‚
â”‚ [0x06, 0x06, 0x02, 0xAB, 0x10, 0x00]                       â”‚
â”‚                                                            â”‚
â”‚ Algorithm: CRC-16-MODBUS                                   â”‚
â”‚ 1. Start with 0xFFFF                                       â”‚
â”‚ 2. For each byte:                                          â”‚
â”‚    - XOR with CRC                                          â”‚
â”‚    - For each bit:                                         â”‚
â”‚      - If LSB is 1: shift right, XOR with 0xA001           â”‚
â”‚      - Else: just shift right                              â”‚
â”‚                                                            â”‚
â”‚ Result: 16-bit CRC, sent LSB first                         â”‚
â”‚ Example: CRC = 0x1234 â†’ send [0x34, 0x12]                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

WHY CRC?
Detects errors in transmission:
- Single bit errors: 100% detection
- Double bit errors: 100% detection
- Burst errors: >99.998% detection
- Random errors: 99.998% detection
```

---

## WebSocket vs HTTP Polling Comparison

```
METHOD 1: HTTP POLLING (Not used in this project, but for comparison)
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

Browser                         Server
   â”‚                               â”‚
   â”œâ”€ GET /api/messages â”€â”€â”€â”€â”€â”€â”€â”€> â”‚
   â”‚                               â”œâ”€ Query messages
   â”‚ <â”€â”€â”€â”€ JSON response â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚
   â”‚                               â”‚
   â”œâ”€ [wait 1 second]              â”‚
   â”‚                               â”‚
   â”œâ”€ GET /api/messages â”€â”€â”€â”€â”€â”€â”€â”€> â”‚
   â”‚                               â”œâ”€ Query messages (again)
   â”‚ <â”€â”€â”€â”€ JSON response â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚
   â”‚                               â”‚
   â”œâ”€ [wait 1 second]              â”‚
   â”‚                               â”‚
   â”œâ”€ GET /api/messages â”€â”€â”€â”€â”€â”€â”€â”€> â”‚
   â”‚                               â”œâ”€ Query messages (again)
   â”‚ <â”€â”€â”€â”€ JSON response â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚
   â”‚                               â”‚
   â””â”€ [repeat forever...]          â”‚

PROBLEMS:
âœ— Wasteful (sends request even when no new data)
âœ— Latency (up to 1 second delay to see new messages)
âœ— Server load (constant requests)
âœ— Bandwidth waste (full HTTP headers every time)


METHOD 2: WEBSOCKET (What we use!)
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

Browser                         Server
   â”‚                               â”‚
   â”œâ”€ WebSocket connect â”€â”€â”€â”€â”€â”€â”€â”€> â”‚
   â”‚ <â”€â”€â”€â”€ connected â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚
   â”‚                               â”‚
   â”‚            [PERSISTENT CONNECTION]
   â”‚                               â”‚
   â”‚                               â”œâ”€ New message arrives!
   â”‚ <â”€â”€â”€â”€ push: new_messages â”€â”€â”€â”€ â”‚  (instant!)
   â”‚                               â”‚
   â”‚                               â”œâ”€ New message arrives!
   â”‚ <â”€â”€â”€â”€ push: new_messages â”€â”€â”€â”€ â”‚  (instant!)
   â”‚                               â”‚
   â”‚                               â”œâ”€ New message arrives!
   â”‚ <â”€â”€â”€â”€ push: new_messages â”€â”€â”€â”€ â”‚  (instant!)
   â”‚                               â”‚
   â””â”€            [continues...]    â”‚

BENEFITS:
âœ“ Efficient (only sends when there's new data)
âœ“ Real-time (instant updates, no delay)
âœ“ Low server load (one connection, many messages)
âœ“ Low bandwidth (minimal framing overhead)
âœ“ Bi-directional (either side can send anytime)


IMPLEMENTATION IN CODE:

Server side (webserver.py):
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
def broadcast_messages():
    while True:
        time.sleep(0.5)
        if len(vfdserver.recent_messages) > last_message_count:
            new_messages = vfdserver.recent_messages[last_message_count:]
            socketio.emit('new_messages', {'messages': new_messages})
                         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                   â”‚
                        Pushed to ALL connected browsers!

Client side (index.html):
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const socket = io();  // Connect

socket.on('new_messages', (data) => {
    data.messages.forEach(msg => addLogEntry(msg));
});
    â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
            â”‚
    Called automatically when server pushes data!
```

---

## Class Inheritance Diagram

```
ModbusSequentialDataBlock                   (from pymodbus library)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  â€¢ Stores register values in memory    â”‚
â”‚  â€¢ Base implementation                 â”‚
â”‚                                        â”‚
â”‚  Methods:                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ setValues(address, values)       â”‚ â”‚
â”‚  â”‚   â€¢ Stores values in memory      â”‚ â”‚
â”‚  â”‚   â€¢ Basic functionality          â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ getValues(address, count)        â”‚ â”‚
â”‚  â”‚   â€¢ Returns values from memory   â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚
                 â”‚ inherits
                 â”‚
                 â–¼
YaskawaCallback                             (our custom class)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  â€¢ Extends base functionality          â”‚
â”‚  â€¢ Adds translation logic              â”‚
â”‚  â€¢ Forwards to WEG drive               â”‚
â”‚                                        â”‚
â”‚  Overridden Methods:                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ setValues(address, values)       â”‚ â”‚
â”‚  â”‚   1. super().setValues(...)      â”‚ â”‚ â† Call parent
â”‚  â”‚      (store in memory)           â”‚ â”‚
â”‚  â”‚   2. Check which register        â”‚ â”‚
â”‚  â”‚   3. Translate Yaskawa â†’ WEG     â”‚ â”‚
â”‚  â”‚   4. Forward to WEG drive        â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                        â”‚
â”‚  New Methods:                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ _write_to_weg(reg, val, name)    â”‚ â”‚
â”‚  â”‚   â€¢ Thread-safe writing          â”‚ â”‚
â”‚  â”‚   â€¢ Error handling               â”‚ â”‚
â”‚  â”‚   â€¢ Logging                      â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

WHY INHERITANCE?
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
1. Reuse existing functionality (storage, addressing)
2. Customize behavior (add translation)
3. Integrate with pymodbus framework (expects this interface)
4. Don't reinvent the wheel!

POLYMORPHISM IN ACTION:
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
pymodbus code:
    datablock.setValues(0x0002, [3000])
              â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜
                   â”‚
            Could be any class that inherits from
            ModbusSequentialDataBlock!
                   â”‚
                   â”œâ”€> If YaskawaCallback: Translates to WEG
                   â”œâ”€> If base class: Just stores in memory
                   â””â”€> Custom behavior without changing pymodbus!
```

---

## Configuration Flow

```
USER CHANGES CONFIG â†’ BROWSER â†’ SERVER â†’ GATEWAY â†’ SAVED IN MEMORY
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

1. User types in web form:
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚ Port WEG: [COM5____]    â”‚  â† Changed from COM4 to COM5
   â”‚                         â”‚
   â”‚ [ğŸ’¾ Save Configuration] â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

2. JavaScript captures form submit:
   document.getElementById('configForm').addEventListener('submit', (e) => {
       e.preventDefault();  // Don't reload page!
       
       const config = {
           PORT_WEG: document.getElementById('portWeg').value,  // "COM5"
           // ... other fields
       };

3. JavaScript sends HTTP POST:
       fetch('/api/config', {
           method: 'POST',
           headers: { 'Content-Type': 'application/json' },
           body: JSON.stringify(config)
       });
   })

   HTTP Request:
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚ POST /api/config HTTP/1.1             â”‚
   â”‚ Content-Type: application/json        â”‚
   â”‚                                       â”‚
   â”‚ {                                     â”‚
   â”‚   "PORT_WEG": "COM5",                 â”‚
   â”‚   "BAUD_RATE": 9600,                  â”‚
   â”‚   ...                                 â”‚
   â”‚ }                                     â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

4. Flask receives and routes:
   @app.route('/api/config', methods=['POST'])
   def update_config():
       data = request.json  â† Parse JSON
       
5. Update global config:
       if 'PORT_WEG' in data:
           vfdserver.config['PORT_WEG'] = data['PORT_WEG']
                            â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜
                                 â”‚
                                 â–¼
                    Global dictionary in vfdserver.py
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚ config = {              â”‚
                    â”‚   'PORT_WEG': 'COM5', â† Updated!
                    â”‚   'BAUD_RATE': 9600,    â”‚
                    â”‚   ...                   â”‚
                    â”‚ }                       â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

6. Log the change:
       vfdserver.add_message('INFO', 'Configuration updated')
                   â””â”€â”€â”€â”¬â”€â”€â”€â”€â”˜
                       â”‚
                       â–¼
              Added to recent_messages[]
                       â”‚
                       â–¼
              Broadcast thread sees it
                       â”‚
                       â–¼
              WebSocket pushes to browser
                       â”‚
                       â–¼
              User sees: "âœ“ Configuration updated"

7. Return success:
       return jsonify({
           'success': True,
           'message': 'Configuration updated successfully'
       })

   HTTP Response:
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚ HTTP/1.1 200 OK                       â”‚
   â”‚ Content-Type: application/json        â”‚
   â”‚                                       â”‚
   â”‚ {                                     â”‚
   â”‚   "success": true,                    â”‚
   â”‚   "message": "Configuration updated"  â”‚
   â”‚ }                                     â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

8. JavaScript receives response:
       const data = await response.json();
       showNotification(data.message, 'success');
                       â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â–¼
                    Green popup appears:
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚ âœ“ Configuration updated    â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

IMPORTANT NOTE:
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
Config changes take effect IMMEDIATELY for NEW operations:
âœ“ Next WEG write will use new PORT_WEG

But EXISTING connections stay open:
âœ— If server already running on COM4, won't switch to COM5
â†’ Need to RESTART server for port changes!

This is why the UI makes you stop/start the server.
```

---

## Error Propagation Example

```
SCENARIO: WEG Drive is unplugged during operation
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

1. PLC sends command:
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚ PLC: Run at  â”‚
   â”‚ 30Hz         â”‚
   â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
          â”‚
          â–¼
   [COM3] â†’ Gateway receives âœ“

2. Translation occurs:
   YaskawaCallback.setValues()
   â”œâ”€ val = 3000 (Yaskawa)
   â”œâ”€ val_weg = 4096 (WEG)
   â””â”€ Call _write_to_weg(683, 4096)

3. Attempt to write:
   def _write_to_weg(register, value, command_name):
       with weg_lock:
           try:
               result = weg_client.write_register(683, 4096, slave=6)
                                  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                           â”‚
                                           â–¼
                                   [COM4] â†’ No device! âœ—
                                           â”‚
                                           â–¼
                                   ModbusIOException raised!

4. Exception caught:
           except Exception as e:
               add_message('ERROR', f"Exception: {str(e)}")
               â”‚                     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â”‚                                â”‚
               â”‚                                â–¼
               â”‚                    "Modbus Error: [Input/Output] 
               â”‚                     No Connection"
               â”‚
               â””â”€> Try to reconnect:
                   if weg_client:
                       weg_client.close()

5. Error logged:
   recent_messages.append({
       'type': 'ERROR',
       'message': 'Exception writing FREQUENCY to WEG: No Connection'
   })
   â”‚
   â””â”€> Broadcast thread picks it up
       â”‚
       â””â”€> WebSocket pushes to browser
           â”‚
           â””â”€> User sees:

   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚ Log Entry (red border):                              â”‚
   â”‚ 2026-02-01 10:30:15.234  [ERROR]                     â”‚
   â”‚ Exception writing FREQUENCY to WEG: No Connection    â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

6. Next command will retry connection:
   if weg_client is None or not weg_client.connected:
       if not init_weg_client():  â† Attempt reconnect
           add_message('ERROR', "Cannot write: WEG not connected")
           return  â† Don't try to write

GRACEFUL DEGRADATION:
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
âœ“ Gateway doesn't crash
âœ“ Error clearly reported to user
âœ“ Automatic reconnection attempts
âœ“ Other functions continue working (web interface still responsive)
âœ“ When WEG plugged back in, next command will reconnect

This is called "fault tolerance"!
```

This diagram document provides visual representations of all the key concepts!
